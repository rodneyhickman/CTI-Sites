<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>CTI: Learning Hub: Login</title>
<meta http-equiv="Content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="Content-Language" content="en" />
<meta name="language" content="en" />
<meta name="keywords" content="" />
<meta name="description" content="" />
<meta name="author" content="The Coaches Training Institute (CTI)" />
<meta name="copyright" content="Copyright &#169; 2009 The Coaches Training Institute. All rights reserved." />
<link rel="icon" href="/favicon.ico" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="stylesheet" type="text/css" href="/res/css/coaches-training-institute.css" />
<link rel="stylesheet" type="text/css" href="/res/css/section_coach-training.css" />

<link rel="stylesheet" type="text/css" href="/res/css/content_internal_11c.css" /> 
<link rel="stylesheet" type="text/css" href="/res/css/mentor.css" />

<script src="http://www.google.com/jsapi"></script>
<script>
google.load("jquery", "1.4.2");
google.setOnLoadCallback(function() {
});
</script>
</head>
<body>
<div id="page">
  <img id="portraits" src="/images/course-materials-portraits.png" />
<div id="tools">
  <!-- generalID --><!-- -->
  <!-- eCommerceID --><!-- -->
  <!-- courseMaterialsID --><& '/res/inc/id_course_materials.html' &><!-- -->
</div>
<div id="primary">
  <!-- contactNavID --><!-- -->
  <ul id="main-nav">
  </ul>
  
<div id="broadcast">
  <img src="/res/img/page-banners/content_course_login.gif" width="920" height="124" alt="Coach Training" usemap="#logobutton" />
  <map id="logobutton" name="logobutton">
  <area shape="rect" coords="822,0,899,103" href="/" title="CTI Home" alt="CTI Home" />
  </map>
</div>


<div id="content">

<div id="main">

  

<div id="breadcrumbs">

  <!--<p><span id="youarehere" class="accessibility-hide">You are here:&#160;</span> <a href="/">Home</a><span class="divider">&#160;||&#160;</span><a href="/contact/" class="here">Policies</a></p>-->

</div>



<h1 id="main-headline">Enter your email address to request a new password</h1>







<div class="pri">

% if($request_ok == 1){
 <p>You will receive an email with instructions to reset your password.</p>
% } elsif($request_ok == -1){
 <p>We were not able to find your email address in our database. Please contact us at 1-800-691-6008. Thank you. </p>
% } else {
 <form action="reset-password-request.html" method="POST">
     <table>
    <tr>
  <th><label for="signin_username">Email address</label></th>
  <td><input type="text" name="email" id="signin_username" /></td>
</tr>

  <tr><td></td><td>
  <input type="submit" value="Request Password Reset" />
  </td></tr>

  </table>

</form>
% }
 
%# <% Dumper {values => \%values, err => $err, url => $url, result => $result, email => $email, date => `date`, } %>
 




</div>
</div>




<!-- ctaAreaId -->

<div id="cta-area">

</div>

<!-- -->

</div>





<!-- used for cross-browser stabilizion of layout -->
<div class="pageclear"></div>
</div>
<div id="footer">
  <img id="cti-logo-tagged" src="/res/img/cti-changing-business-transforming-lives.gif" width="176" height="57" alt="cit: changing business. transforming lives."/>
<div id="footer-content">
  <!-- footerNavId --><& '/res/inc/id_footer-nav-course-matls.html' &><!-- -->
  <img id="icf-logo" src="/res/img/icf-logo.gif" width="74" height="57" alt="International Coach Federation"/>
</div>
</div>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-5715102-1");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>

<%once>
 use CTI::Secret;
 use Digest::SHA1;
 use URI::Escape;
 use Mail::Sendmail qw(sendmail);
</%once>
<%init>
my $args       = $m->request_args();

my ($email)    = @{$args}{'email'};
$email =~ s/[^A-Za-z0-9\@\_\-\.]//gms; #untaint email address
my ($redirect) = @{$args}{'r'};

my $err        = '';
my $url        = '';
my $result     = '';
my %values;
my $request_ok = 0;

if($redirect){
  Apache2::Cookie->new
  ( $r,
    -name  => 'pwredirect',
    -value => { redirect => $redirect },
    -path  => '/',
    -domain => '.thecoaches.com',
    -expires => '+3d',
  )->bake($r);

}

if ($email) {
  # check email address in database

  my $em = uri_escape( $email,    '^A-Za-z0-9@.-_' );

  $url = "http://webcomp.modelsmith.com/fmi-test/webcomp2_newFM/lookup.php?postkey=fjgh15t&em=$em";
  $result = `/usr/bin/curl '$url'`;

  if($result eq 'ok'){
    # create unique key
    my $text = "bcdfghjkmnpqrstvwxyzABCDEFGHJKLMNPRSTUVWXYZ23456789";
    my $length = int(rand() * 2) + 14;
    my $x = 0;
    my $key = "";
    while ($x<$length) {
      my $ranNo = int(rand() * length($text));
      my $a = substr($text, $ranNo, 1);
      $key .= $a; $x++;
    }

    # save in local database (auth_users table)
    my ($id) = $dbh->selectrow_array('SELECT id FROM auth_users WHERE username=?',undef,$email);

    if ($id > 0) {
      $dbh->do('UPDATE auth_users SET passwd=? WHERE id=?',undef,$key,$id);
    } else {
      $dbh->do('INSERT INTO auth_users (username,passwd) values (?,?)',undef,$email,$key);
    }
    # send email

my $MAIL = qq{We have received your request for a password reset. Please click the
following link to continue. If you did not make this request, please
disregard and delete this email.

http://www.thecoaches.com/coactiveselling/reset-password.html?k=$key

The Coaches Training Institute
1-800-691-6008
};

my %mail = (   To      => $email,
            From    => 'registration@thecoaches.com',
            Subject =>  "Subject: CTI Password Reset Request",
            Message => $MAIL,
Smtp    => 'smtp2.modelsmith.com',
Port    => '2225',
           );

sendmail(%mail);

#    my $mailprog = '/usr/lib/sendmail -i -t -f info@thecoaches.com';
#    open(MAIL,"|$mailprog");
#    print MAIL "From: The Coaches Training Institute <info\@thecoaches.com>\n";
#    print MAIL "To: $email\n";
#    print MAIL "Subject: CTI Password Reset Request\n\n";
#    print MAIL $MAIL;
#    close(MAIL);


    $request_ok = 1;
  } else {
    $request_ok = -1;  
  }
}

</%init>
<%flags>
inherit => '../autohandler'
</%flags>
