html_text_js = '<% $html %>';
document.write(html_text_js);
<%once>
use Data::Dumper;
use List::MoreUtils qw{ uniq };
use Date::Manip qw{ ParseDate UnixDate DateCalc };
use CTI::Database qw( get_sql );
</%once>
<%init>


my $NA_sql =<<'EOS';
SELECT id,event,start_date,start_date_formatted,end_date_formatted FROM event_calendar
WHERE (course_type_id=11 or course_type_id=12 or course_type_id=13 or course_type_id=14)
AND (location='MTree' OR location='Wildwood' OR location='Sequoia' OR location="WESTERBEKE")
EOS

my $ES_sql = <<'EOS';
SELECT id,event,start_date,start_date_formatted,end_date_formatted FROM event_calendar
WHERE (course_type_id=11 or course_type_id=12 or course_type_id=13 or course_type_id=14)
AND (location='SPAIN' or location like 'ES%'  or location like 'IT%')
EOS

my $BOI_sql = <<'EOS';
SELECT id,event,start_date,start_date_formatted,end_date_formatted FROM event_calendar
WHERE (course_type_id=11 or course_type_id=12 or course_type_id=13 or course_type_id=14)
AND location like '%BOI'
EOS


my $JP_sql = <<'EOS';
SELECT id,event,start_date,start_date_formatted,end_date_formatted FROM event_calendar
WHERE (course_type_id=11 or course_type_id=12 or course_type_id=13 or course_type_id=14)
AND location like '%HGJC'
EOS



my $args = $m->request_args;
my ($loc) = @{$args}{'loc'};
my $html;


if ($loc eq 'NA') {

  # North American Events
  my ($events) = $dbh->selectall_arrayref($NA_sql,{Columns=>{}});
  for (@$events){
    $_->{event} =~ m/ ( .*? ) [ ] ( \d ) \z /xms; # get pod name
    $_->{pod} = $1;
    my $days = $2 < 3 ? 5 : 4; # 6 days for retreats 1 and 2, 5 days for the rest
    $_->{start_date_formatted} =~ m/ \A ( \w+ ) .*? (\d\d\d\d) \z /xms; # get month

  $_->{month} =  UnixDate( ParseDate($_->{start_date}),"%B %Y");
  $_->{sort_id} = UnixDate(ParseDate($_->{start_date}),"%Y%m%d");
  $_->{start_date_formatted} = UnixDate(ParseDate($_->{start_date}),"%B %d, %Y");
  $_->{end_date_formatted} = UnixDate(DateCalc(ParseDate($_->{start_date}),"+ $days days"),"%B %d, %Y");
  }

  # get names of #1 retreat (i.e. Salmon 1)
  my @pod_names = 
    uniq 
      grep { $_ ne '' }
        map  { $_->{pod} if $_->{event} =~ m/ [ ] 1 \z /xms; } 
          @$events; # 

  # get month of #1 retreat (i.e. Salmon 1)
  my @months = 
    uniq 
      grep { $_ ne '' }
        map  { $_->{month} if $_->{event} =~ m/ [ ] 1 \z /xms; } 
          @$events; # 

  
  # Foreach #1 retreat, get #2, #3, #4 retreats and create $retreats hashref

  my $retreats = [ ];

  foreach my $pod (@pod_names) {
    my @events = 
      sort { $a->{sort_id} <=> $b->{sort_id} }
        grep { $_->{pod} eq $pod } 
          @$events;

    push(@$retreats,
         {
           id       => eval { $events[0]->{sort_id} },
           month    => eval { $events[0]->{month}   },
           retreat1 => eval { $events[0]->{start_date_formatted} . ' - ' . $events[0]->{end_date_formatted} },
           retreat2 => eval { $events[1]->{start_date_formatted} . ' - ' . $events[1]->{end_date_formatted} },
           retreat3 => eval { $events[2]->{start_date_formatted} . ' - ' . $events[2]->{end_date_formatted} },
           retreat4 => eval { $events[3]->{start_date_formatted} . ' - ' . $events[3]->{end_date_formatted} },
         });
    
  }


  $html = qq{<h2 id="calendar-sub-head">Northern California, USA</h2>};
  foreach my $r ( sort { $a->{id} <=> $b->{id} } @$retreats) {
    $html .= qq{<h3> $r->{month} - California</h3>};
    $html .= qq{<p><strong>Retreat 1:</strong> $r->{retreat1}<br />};
    $html .= qq{<strong>Retreat 2:</strong> $r->{retreat2}<br />};
    $html .= qq{<strong>Retreat 3:</strong> $r->{retreat3}<br />};
    $html .= qq{<strong>Retreat 4:</strong> $r->{retreat4}</p>};
  }
  $html .= qq{<p><a href="/leadership/dates-and-locations/retreat_locations.html">Click here for information on the Northern California retreat location.</a></p>};

}

if ($loc eq 'ES') {

  # Spain 

  my ($ES_events) = $dbh->selectall_arrayref($ES_sql,{Columns=>{}});
  for (@$ES_events){
    $_->{event} =~ m/ ( .*? ) [ ] ( \d ) \z /xms; # get pod name
    $_->{pod} = $1;
    my $days = $2 < 3 ? 5 : 4; # 6 days for retreats 1 and 2, 5 days for the rest
    $_->{start_date_formatted} =~ m/ \A ( \w+ ) .*? (\d\d\d\d) \z /xms; # get month

  $_->{month} =  UnixDate( ParseDate($_->{start_date}),"%B %Y");
  $_->{sort_id} = UnixDate(ParseDate($_->{start_date}),"%Y%m%d");
  $_->{start_date_formatted} = UnixDate(ParseDate($_->{start_date}),"%B %d, %Y");
  $_->{end_date_formatted} = UnixDate(DateCalc(ParseDate($_->{start_date}),"+ $days days"),"%B %d, %Y");
  }
  # get names of #1 retreat (i.e. Salmon 1)
  my @ES_pod_names = 
    uniq 
      grep { $_ ne '' }
        map  { $_->{pod} if $_->{event} =~ m/ [ ] 1 \z /xms; } 
          @$ES_events; # 

  # get months and sort them
  my @ES_months = 
    uniq 
      grep { $_ ne '' }
        map  { $_->{month} if $_->{event} =~ m/ [ ] 1 \z /xms; } 
          @$ES_events; # 

  


  # Foreach #1 retreat, get #2, #3, #4 retreats and create $retreats hashref

  my $ES_retreats = [ ];

  foreach my $pod (@ES_pod_names) {
    my @events = 
      sort { $a->{sort_id} <=> $b->{sort_id} }
        grep { $_->{pod} eq $pod } 
          @$ES_events;

    push(@$ES_retreats,
         {
           id       => eval { $events[0]->{sort_id} },
           month    => eval { $events[0]->{month}   },
           retreat1 => eval { $events[0]->{start_date_formatted} . ' - ' . $events[0]->{end_date_formatted} },
           retreat2 => eval { $events[1]->{start_date_formatted} . ' - ' . $events[1]->{end_date_formatted} },
           retreat3 => eval { $events[2]->{start_date_formatted} . ' - ' . $events[2]->{end_date_formatted} },
           retreat4 => eval { $events[3]->{start_date_formatted} . ' - ' . $events[3]->{end_date_formatted} },
         });
    
    
  }

  $html = qq{<h2 id="calendar-sub-head">Sitges, Spain</h2>};
  foreach my $r ( sort { $a->{id} <=> $b->{id} } @$ES_retreats) {
    $html .= qq{<h3> $r->{month} - Spain</h3>};
    $html .= qq{<p><strong>Retreat 1:</strong> $r->{retreat1}<br />};
    $html .= qq{<strong>Retreat 2:</strong> $r->{retreat2}<br />};
    $html .= qq{<strong>Retreat 3:</strong> $r->{retreat3}<br />};
    $html .= qq{<strong>Retreat 4:</strong> $r->{retreat4}</p>};
  }
  $html .= qq{<p><a href="/leadership/dates-and-locations/retreat_locations.html">Click here for information on the Sitges, Spain retreat location.</a></p>};


}


if ($loc eq 'BOI') {

  # BOI

  my ($BOI_events) = $dbh->selectall_arrayref($BOI_sql,{Columns=>{}});
  for (@$BOI_events){
    $_->{event} =~ m/ ( .*? ) [ ] ( \d ) \z /xms; # get pod name
    $_->{pod} = $1;
    my $days = $2 < 3 ? 5 : 4; # 6 days for retreats 1 and 2, 5 days for the rest
    $_->{start_date_formatted} =~ m/ \A ( \w+ ) .*? (\d\d\d\d) \z /xms; # get month

  $_->{month} =  UnixDate( ParseDate($_->{start_date}),"%B %Y");
  $_->{sort_id} = UnixDate(ParseDate($_->{start_date}),"%Y%m%d");
  $_->{start_date_formatted} = UnixDate(ParseDate($_->{start_date}),"%B %d, %Y");
  $_->{end_date_formatted} = UnixDate(DateCalc(ParseDate($_->{start_date}),"+ $days days"),"%B %d, %Y");
  }
  # get names of #1 retreat (i.e. Salmon 1)
  my @BOI_pod_names = 
    uniq 
      grep { $_ ne '' }
        map  { $_->{pod} if $_->{event} =~ m/ [ ] 1 \z /xms; } 
          @$BOI_events; # 

  # get months and sort them
  my @BOI_months = 
    uniq 
      grep { $_ ne '' }
        map  { $_->{month} if $_->{event} =~ m/ [ ] 1 \z /xms; } 
          @$BOI_events; # 

  


  # Foreach #1 retreat, get #2, #3, #4 retreats and create $retreats hashref

  my $BOI_retreats = [ ];

  foreach my $pod (@BOI_pod_names) {
    my @events = 
      sort { $a->{sort_id} <=> $b->{sort_id} }
        grep { $_->{pod} eq $pod } 
          @$BOI_events;

    push(@$BOI_retreats,
         {
           id       => eval { $events[0]->{sort_id} },
           month    => eval { $events[0]->{month}   },
           retreat1 => eval { $events[0]->{start_date_formatted} . ' - ' . $events[0]->{end_date_formatted} },
           retreat2 => eval { $events[1]->{start_date_formatted} . ' - ' . $events[1]->{end_date_formatted} },
           retreat3 => eval { $events[2]->{start_date_formatted} . ' - ' . $events[2]->{end_date_formatted} },
           retreat4 => eval { $events[3]->{start_date_formatted} . ' - ' . $events[3]->{end_date_formatted} },
         });
    
    
  }

  $html = qq{<h2 id="calendar-sub-head">East Coast, USA</h2>};
  foreach my $r ( sort { $a->{id} <=> $b->{id} } @$BOI_retreats) {
    $html .= qq{<h3> $r->{month} - East Coast</h3>};
    $html .= qq{<p><strong>Retreat 1:</strong> $r->{retreat1}<br />};
    $html .= qq{<strong>Retreat 2:</strong> $r->{retreat2}<br />};
    $html .= qq{<strong>Retreat 3:</strong> $r->{retreat3}<br />};
    $html .= qq{<strong>Retreat 4:</strong> $r->{retreat4}</p>};
  }
  $html .= qq{<p><a href="/leadership/dates-and-locations/retreat_locations.html">Click here for information on the East Coast retreat location.</a></p>};


}



</%init>
